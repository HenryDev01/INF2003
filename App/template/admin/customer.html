{% extends 'admin_base.html' %}
{% block links %}

  <link href="../static/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
 <link href="../static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href = '../static/css/sb-admin-2.min.css' rel = 'stylesheet'>
<link href = '../static/css/style.css' rel = 'stylesheet'>
{% endblock %}
{% block pageContent %}
<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
                  <form id = "addForm" novalidate>

      <div class="modal-header">
          <h4 class="modal-title">Add Users</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>

      </div>
      <div class="modal-body">
            <div class = "group">
                <label for="username" class="float-label" style="font-size:12px"><i class="	fa fa-id-card" style  = "padding-right:2px;"></i>&nbspUsername</label>
                <input type="text" id="username" class="form-control"  name = "username" required="">
                <span class="form-highlight"></span>
                <span class="form-bar"></span>
			    <span id="error_username" class="text-danger"></span>
            </div>
            <div class  ="group">
                <label for="name" class="float-label" style="font-size:12px" ><i class = "fa fa-user" style  = "padding-left:2px;"></i>&nbspName</label>
                <input type="text" id="name" class="form-control"  name = "name" required="">
                <span class="form-highlight"></span>
                <span class="form-bar"></span>
            <span id="error_name" class="text-danger"></span>
            </div>


            <div class = "group">
                <label for="contact" class="float-label" style="font-size:12px;"><i class = "fa fa-phone" style  = "padding:2px;"></i>&nbspContact</label>
                <input type = "text" id="contact" class="form-control" name = "contact" required="">
                <span class="form-highlight"></span>
                <span class="form-bar"></span>
                <span id="error_contact" class="text-danger"></span>
            </div>

             <div class  ="group">
                 <label for="email" class="float-label" style="font-size:12px"><i class = "fa fa-envelope" style = "padding-right:2px;"></i>&nbspEmail</label>
                 <input type = "text" id="email" class="form-control" name = "email" required="">
                 <span class="form-highlight"></span>
                 <span class="form-bar"></span>
                 <span id="error_email" class="text-danger"></span>
            </div>
            <div class  ="group">
                <label for="zipcode" class="float-label" style="font-size:12px"><i class = "fa fa-map-pin" style = "padding-right:2px;"></i>&nbspZip Code</label>
                <input type = "text" id="zipcode" class="form-control" name = "zipcode" required="">
                <span class="form-highlight"></span>
                <span class="form-bar"></span>
                <span id="error_zipcode" class="text-danger"></span>
           </div>
            <div class = 'group'>
                <label style="font-size:12px" for = 'password' class = 'float-label' name = 'password'><i class = 'fa fa-lock'></i>&nbspPassword</label>
                <input type = "password" id = 'password' class = "form-control" name = 'password' required="">
                <span class = 'form-highlight'></span>
                <span class = 'form-bar'></span>
                <span id="error_password" class="text-danger"></span>
            </div>

              <div class = 'group'>
                  <label style="font-size:12px" for = 'confirmpassword' class = 'float-label' name = 'confirmpassword'><i class = 'fa fa-lock'></i>&nbspConfirm Password</label>
                <input type = "password" id = 'confirmpassword' class = "form-control" name = 'confirmpassword' required="">
                <span class = 'form-highlight'></span>
                <span class = 'form-bar'></span>
                  <span id="error_confirmpassword" class="text-danger"></span>

            </div>

      </div>

      <div class="modal-footer">
<input type  ="submit" id = "admSubmit" class = "btn btn-success" value  = "Add">
      </div>
                                </form>

    </div>


  </div>
</div>

<div id="updateModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
        <form id = "updateForm" novalidate>
      <div class="modal-header">
          <h4 class="modal-title">Update Users</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>

      </div>
      <div class="modal-body">

        <div class = "group">
            <label for="username2" class="float-label" style="font-size:12px"><i class="	fa fa-id-card" style  = "padding-right:2px;"></i>&nbspUsername</label>
            <input type="text" id="username2" class="form-control"  name = "username2" required="" readonly>
            <span class="form-highlight"></span>
            <span class="form-bar"></span>
            <span id="error_username2" class="text-danger"></span>
        </div>
        <div class  ="group">
            <label for="name2" class="float-label" style="font-size:12px" ><i class = "fa fa-user" style  = "padding-left:2px;"></i>&nbspName</label>
            <input type="text" id="name2" class="form-control"  name = "name2" required="">
            <span class="form-highlight"></span>
            <span class="form-bar"></span>
        <span id="error_name2" class="text-danger"></span>
        </div>


        <div class = "group">
            <label for="contact2" class="float-label" style="font-size:12px;"><i class = "fa fa-phone" style  = "padding:2px;"></i>&nbspContact</label>
            <input type = "text" id="contact2" class="form-control" name = "contact2" required="">
            <span class="form-highlight"></span>
            <span class="form-bar"></span>
            <span id="error_contact2" class="text-danger"></span>
        </div>

         <div class  ="group">
             <label for="email2" class="float-label" style="font-size:12px"><i class = "fa fa-envelope" style = "padding-right:2px;"></i>&nbspEmail</label>
             <input type = "text" id="email2" class="form-control" name = "email2" required="">
             <span class="form-highlight"></span>
             <span class="form-bar"></span>
             <span id="error_email2" class="text-danger"></span>
        </div>
        <div class  ="group">
            <label for="zipcode2" class="float-label" style="font-size:12px"><i class = "fa fa-map-pin" style = "padding-right:2px;"></i>&nbspZip Code</label>
            <input type = "text" id="zipcode2" class="form-control" name = "zipcode2" required="">
            <span class="form-highlight"></span>
            <span class="form-bar"></span>
            <span id="error_zipcode2" class="text-danger"></span>
       </div>

<!--            <div class = 'group'>-->
<!--                <input type = "password" id = 'admPassword2' class = "form-control" name = 'password' required="">-->
<!--                <span class = 'form-highlight'></span>-->
<!--                <span class = 'form-bar'></span>-->
<!--                <label for = 'admPassword2' class = 'float-label' name = 'password'><i class = 'fa fa-lock'></i>&nbspPassword</label>-->
<!--            </div>-->

<!--              <div class = 'group'>-->
<!--                <input type = "password" id = 'admconfirmPassword2' class = "form-control" name = 'password' required="">-->
<!--                <span class = 'form-highlight'></span>-->
<!--                <span class = 'form-bar'></span>-->
<!--                <label for = 'admconfirmPassword2' class = 'float-label' name = 'confirmPassword'><i class = 'fa fa-lock'></i>&nbspConfirm Password</label>-->
<!--            </div>-->

      </div>

      <div class="modal-footer">
<input type  ="submit" id = "admSubmit2" class = "btn btn-info" value  = "Update">
      </div>
                  </form>

    </div>


  </div>
</div>




 <!-- Begin Page Content -->
        <div class="container-fluid">

          <!-- Page Heading -->
          <h1 class="h3 mb-2 text-gray-800">User</h1>
  {% with errors = get_flashed_messages(category_filter=["error"]) %}
            {% if errors %}
                {%- for message in errors %}
                    <div class="alert alert-danger alert-dismissible fade show error" role="alert">
                        <p style="font-size:10px;">{{ message }}</p>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor -%}
            {% endif %}
        {% endwith %}
          <!-- DataTales Example -->
          <div class="card shadow mb-4">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">User Accounts</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive" style = "">
                    {% if session['Role'] == 'SysAD'  or session['Role'] == 'User Administrator' %}
                            <button style = 'float:right; margin-left:100px;'class="btn btn-success" id = "addBtn" data-toggle="modal" data-target="#myModal" >Create New Account</button>
                    {% else %}
                            <button style = 'float:right; margin-left:100px;'class="btn btn-success"   data-toggle="modal" data-target="#myModal" >Create New Account</button>
                    {% endif %}

               <table class = "table table-bordered" id = "dataTable" cellspacing="0" style  ="width:100%;">

                    <tr>
                    <thead>
                        <th>Customer ID</th>
                        <th>Photo</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Email</th>
                        <th>Zip Code</th>
                        <th>Actions</th>
                    </thead>
                        </tr>

                    <thead>
                    <tr>
                        <th>Customer ID</th>
                        <th>Photo</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Email</th>
                        <th>Zip Code</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                </table>
              </div>
            </div>
          </div>

        </div>
        <!-- /.container-fluid -->
{% endblock %}
{% block script %}
<!-- Bootstrap core JavaScript-->
  <script src="../static/vendor/jquery/jquery.min.js"></script>
  <script src="../static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Core plugin JavaScript-->
  <script src="../static/vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Custom scripts for all pages-->
  <script src="../static/js/sb-admin-2.min.js"></script>

  <!-- Page level plugins -->
  <script src="../static/vendor/datatables/jquery.dataTables.min.js"></script>
  <script src="../static/vendor/datatables/dataTables.bootstrap4.min.js"></script>
<!--    <script src = "../static/form.js"></script>script-->
  <!-- Page level custom scripts -->


    <script>
     function load(){
        $('#dataTable').DataTable({
            'processing':true,
            'serverSide':false,
            'ajax':{url:"/admin_retrieve_client"},
            'columns':[
                {data:"customer_id"},
                {data:"photo"},
                {data:"username"},
                {data:"name"},
                {data:"contact"},
                {data:"email"},
                {data:"customer_zip_code"},
                {data:"Actions"}

            ]
        });
        }
function arrayRemove(arr, value) {

   return arr.filter(function(ele){
       return ele != value;
   });

}
 $(document).ready(function(){








 jQuery(function($) {
       /*     $('tbody tr').each(function(){

              $(this).append("<td></td>");
        });*/

        });
     var csrftoken = $('meta[name=csrf-token]').attr('content')

            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken)
                    }
                }
            })




        $(document).on('click','#deleteBtn',function(){
           var id = $(this).closest('tr').children('td:first').text();
           console.log(id);
           var username = $(this).closest('tr').children('td:nth-child(3)').text();
           console.log(username);

            var cfm;
            cfm = confirm("Are you sure you want to delete this record with the username of "+username+"?");


           if(cfm)
           {

            var reason = prompt('Please state your reason for deleting');
            if(reason)
            {
            $.ajax({
                data:{id:id},
                dataType:'json',
                type:'POST',
                url:'/admin_delete_client',
                success:function(data){
                   alert("Succesfully deleted!")
                   window.location.reload();
                  var table = $('#dataTable').DataTable();
                 table.clear().destroy();
                  load();
                },
                error:function(error){

                    alert('Unable to delete.This user has pending order, cancel the order first!');
                },
                done:function(){

                }
            });
            }else
            {
                alert('Please key in your reason!')
            }
            }
        });

        $(document).on('click','#updateBtn',function(){
            var id  =  $(this).closest('tr').children('td:first').text();
            var username = $(this).closest('tr').children('td:nth-child(3)').text();
            var name = $(this).closest('tr').children('td:nth-child(4)').text();
            var contact = $(this).closest('tr').children('td:nth-child(5)').text();
            var email = $(this).closest('tr').children('td:nth-child(6)').text();
            var zipcode = $(this).closest('tr').children('td:nth-child(7)').text();

           // var password = $(this).closest('tr').children('td:nth-child(9)').text();

            var usernameField = $('#username2').val(username);
            var nameField = $("#name2").val(name);
            var contactField = $("#contact2").val(contact);
            var emailField = $("#email2").val(email);
            var zipcodeField = $("#zipcode2").val(zipcode);
            //var passwordField = $("#admPassword2").val(password);



            $("#updateForm").on('submit',function(e){
                /*
                  var userString = '{% for i in userList %}{{i|safe}}{% endfor %}';
                    var newUserString =userString.substring(1,userString.length-1);
                    var newUsers = newUserString.replace(/['"\s]+/g, '');
                    var userList = newUsers.split(',');
                    var newUserList = arrayRemove(userList,username);
                        console.log(newUserList);
                      var emailString = '{% for i in emailList %}{{i|safe}}{% endfor %}';
                    var newEmailString =emailString.substring(1,emailString.length-1);
                    var newEmail = newEmailString.replace(/['"\s]+/g, '');
                    var emailList = newEmail.split(',');
                    var newEmailList = arrayRemove(emailList,email);
                    console.log(newEmailList);
                     var name = $('#admNRIC2').val().trim();
                    var fname = $('#admFName2').val().trim();
                    var lname = $('#admLName2').val().trim();
                    var contact = $('#admContact2').val().trim();
                    var emails = $('#admEmail2').val().trim();


                     var error_username = '';
                    var error_fname = '';
                    var error_lname = '';
                    var error_contact = '';
                    var error_email = '';


                     var contact_validate =/^[689]\d{7}$/;
                    var email_validate =/^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/;
                    var fname_validate =/^([a-zA-Z' ]+)$/;
                    var lname_validate =/^([a-zA-Z' ]+)$/;


              if($.trim($('#admFName2').val()).length == 0)
         {
              error_fname = '*This field is mandatory!';
          $('#error_fname2').text(error_fname);
          $('#error_fname2').addClass('has-error');

         }else
         {  if(!fname_validate.test($('#admFName2').val()))
            {

                error_fname = 'Please enter a valid name!';
                $('#error_fname2').text(error_fname);
                $('#error_fname2').addClass('has-error');
            }else if($.trim($('#admFName2').val()).length > 100)
            {
                 error_fname = 'This field should not exceed more than 100 characters!';
                $('#error_fname2').text(error_fname);
                $('#error_fname2').addClass('has-error');
            }

             else
            {
                error_fname = '';
                $('#error_fname2').text(error_fname);
                $('#admFName2').removeClass('has-error');
            }
         }



                      if($.trim($('#admNRIC2').val()).length == 0)
                         {
                              error_username = '*This field is mandatory!';
                          $('#error_NRIC2').text(error_username);
                          $('#error_NRIC2').addClass('has-error');

                         }else
                     {
                            if(newUserList.includes(name))
                            {
                                  error_username = 'This username is already taken!';
                                  $('#error_NRIC2').text(error_username);
                                  $('#error_NRIC2').addClass('has-error');

                            }else
                            {
                            error_username = '';
                            $('#error_NRIC2').text(error_username);
                            $('#error_NRIC2').removeClass('has-error');
                            }
                     }

                      if($.trim($('#admLName2').val()).length == 0)
         {
              error_lname = '*This field is mandatory!';
          $('#error_lname2').text(error_lname);
          $('#error_lname2').addClass('has-error');

         }else
         {
               if(!lname_validate.test($('#admLName2').val()))
                {

                error_lname = 'Please enter a valid name!';
                $('#error_lname2').text(error_lname);
                $('#error_lname2').addClass('has-error');
            }else if($.trim($('#admLName2').val()).length > 100)
            {
                 error_lname = 'This field should not exceed more than 100 characters!';
                $('#error_lname2').text(error_lname);
                $('#error_lname2').addClass('has-error');
            }else{

                error_lname = '';
                $('#error_lname2').text(error_lname);
                $('#admLName2').removeClass('has-error');
                }
         }

          if($.trim($('#admContact2').val()).length == 0)
         {
              error_contact = '*This field is mandatory!';
          $('#error_contact2').text(error_contact);
          $('#error_contact2').addClass('has-error');

         }else
         {
                if(!contact_validate.test($('#admContact2').val()))
                {
                     error_contact = 'Please enter an 8 digit number starting with 6,8 or 9';
                     $('#error_contact2').text(error_contact);
                     $('#error-contact2').addClass('has-error');

                }
                else{
                error_contact = '';
                $('#error_contact2').text(error_contact);
                $('#admContact2').removeClass('has-error');
         }
        }

           if($.trim($('#admEmail2').val()).length == 0)
         {
              error_email = '*This field is mandatory!';
          $('#error_email2').text(error_email);
          $('#error_email').addClass('has-error');

         }else
         {


               if (!email_validate.test($('#admEmail2').val()))
                {
                     error_email = 'Please enter a valid email';
                 $('#error_email2').text(error_email);
                 $('#error_email2').addClass('has-error');
                }else if(newEmailList.includes(emails))
                    {
                error_email = 'Email is already taken!';
                 $('#error_email2').text(error_email);
                 $('#error_email2').addClass('has-error');
                    }
                else
                {
                     error_email = '';
                 $('#error_email2').text(error_email);
                 $('#admEmail2').removeClass('has-error');
                }
         }


             if(error_username != '' || error_fname != '' || error_lname != '' || error_contact != '' || error_email != '' || error_contact !='')
                {
                    return false
                }
                */
                
             if(confirm('Are you sure you want to update the following fields'))
            {
                $.ajax({
                    data:{username:usernameField.val(),name:nameField.val(),contact:contactField.val(),email:emailField.val(),zipcode:zipcodeField.val()},
                    dataType:'json',
                    type:'POST',
                    url:'/admin_update_client',
                    success:function(data)
                    {
                        alert('Successfully updated');
                    },
                    //error:function(data)
                   // {
                    //    alert('Email is already taken!')
                  //  }
                });

                }
            });

            
        });





    $("#addForm").on('submit', function (e) {
        e.preventDefault();
            
        var username = $('#username').val().trim();
        var name = $('#name').val().trim();
        var contact = $('#contact').val().trim();
        var email = $('#email').val().trim();
        var zipcode = $('#zipcode').val().trim();
        var password = $('#password').val().trim();
        var confirmPassword = $('#confirmpassword').val().trim();

        var error_username = '';
        var error_name = '';
        var error_contact = '';
        var error_email = '';
        var error_password = '';
        var error_confirmPassword = '';
        var error_zipcode = '';

        var contact_validate = /^[689]\d{7}$/;
        var email_validate = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        var name_validate = /^([a-zA-Z' ]+)$/;

        if (username.length === 0) {
            error_username = '*This field is mandatory!';
            $('#error_username').text(error_username).addClass('has-error');
        }
        else {
            $('#error_username').text('').removeClass('has-error');
        }

        if (name.length === 0) {
            error_name = '*This field is mandatory!';
            $('#error_name').text(error_name).addClass('has-error');
        } else if (!name_validate.test(name)) {
            error_name = 'Please enter a valid name!';
            $('#error_name').text(error_name).addClass('has-error');
        } else if (name.length > 100) {
            error_name = 'Name should not exceed 100 characters!';
            $('#error_name').text(error_name).addClass('has-error');
        } else {
            $('#error_name').text('').removeClass('has-error');
        }

        if (contact.length === 0) {
            error_contact = '*This field is mandatory!';
            $('#error_contact').text(error_contact).addClass('has-error');
        } else if (!contact_validate.test(contact)) {
            error_contact = 'Please enter an 8-digit number starting with 6, 8 or 9';
            $('#error_contact').text(error_contact).addClass('has-error');
        } else {
            $('#error_contact').text('').removeClass('has-error');
        }

        if (email.length === 0) {
            error_email = '*This field is mandatory!';
            $('#error_email').text(error_email).addClass('has-error');
        } else if (!email_validate.test(email)) {
            error_email = 'Please enter a valid email!';
            $('#error_email').text(error_email).addClass('has-error');
        } else {
            $('#error_email').text('').removeClass('has-error');
        }

        if (zipcode.length === 0) {
            error_zipcode = '*This field is mandatory!';
            $('#error_zipcode').text(error_zipcode).addClass('has-error');
        } else {
            $('#error_zipcode').text('').removeClass('has-error');
        }

        if (password.length === 0) {
            error_password = '*This field is mandatory!';
            $('#error_password').text(error_password).addClass('has-error');
        } else {
            $('#error_password').text('').removeClass('has-error');
        }

        if (confirmPassword.length === 0) {
            error_confirmPassword = '*This field is mandatory!';
            $('#error_confirmPassword').text(error_confirmPassword).addClass('has-error');
        } else if (password !== confirmPassword) {
            error_password = 'Passwords do not match!';
            error_confirmPassword = 'Passwords do not match!';
            $('#error_password').text(error_password).addClass('has-error');
            $('#error_confirmPassword').text(error_confirmPassword).addClass('has-error');
        } else {
            $('#error_confirmPassword').text('').removeClass('has-error');
        }

        if (error_username || error_name || error_contact || error_email || error_password || error_confirmPassword || error_zipcode) {
            return false;
        }

        if (confirm('Are you sure you want to add this user?')) {
            $.ajax({
                url: '/admin_add_client',
                type: 'POST',
                data: {
                    username,
                    name,
                    contact,
                    email,
                    zipcode,
                    password
                },
                dataType: 'json',
                success: function (data) {
                    alert('User successfully added');
                    $('#myModal .close').click();
                    $('.modal-backdrop').removeClass('modal-backdrop');
                    $('.fade').removeClass('fade');
                    $('.in').removeClass('in');
                    var table = $('#dataTable').DataTable();
                    table.clear().destroy();
                    location.reload();
                },
                //error: function (data) {
                  //  alert('An error occurred. Username or email might be taken');
                //}
            });
        }
        location.reload();
    });

load();


    });


</script>
{% endblock %}
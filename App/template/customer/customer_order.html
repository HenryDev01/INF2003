{% extends 'customer_base.html' %}
{% block links %}
<link rel="stylesheet" src="../static/css/style.css">
{% endblock %}

{% block content %}
<div class="breadcumb_area bg-img" style="background-image: url({{ url_for('static', filename='img/bg-img/bg-7.jpg') }});">
    <div class="container h-100">
        <div class="row h-100 align-items-center">
            <div class="col-12">
                <div class="page-title text-center">
                    <h2>Your Order</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mt-4" id="orderStatusTabs" role="tablist">
        {% for tab in ['all', 'packed', 'processing', 'shipped', 'delivered', 'cancelled', 'refunded', 'refund requested', 'refund rejected'] %}
        <li class="nav-item">
            <a style="color:black;" class="nav-link {% if status == tab %}active{% endif %}" href="{{ url_for('Customer.customer_order', status=tab) }}">
                {{ tab.capitalize() }}
            </a>
        </li>
    {% endfor %}
    </ul>

    <!-- Orders Table -->
    <div class="table-responsive">
    {% if orders|length > 0 %}
        <input type="text" id="OrderSearch" placeholder="Search Orders" class="form-control mb-3">
    {% endif %}

        <div class="accordion" id="accordionOrders">

        {% for order in orders %}
   
            <div class="card test">
                <div class="card-header bg-light">
                    <table class="table mb-0 table-bordered">
                        <thead class="table-secondary">
                            <tr>
                                <th>Order ID</th>
                                <th>Address</th>
                                <th>Postal</th>
                                <th>Purchase Date</th>
                                <th>Estimated Delivery Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="order-id">{{ order.order_id }}</td>
                                <td>{{ order.shipping_address }}</td>
                                <td>{{ order.shipping_postal_code }}</td>
                                <td>{{ order.order_purchase_date }}</td>
                                <td>{{ order.order_estimate_delivery }}</td>
                                <td>
                                    {% set status_colors = {
                                        'packed': 'warning',
                                        'processing': 'primary',
                                        'shipped': 'info',
                                        'delivered': 'success',
                                        'cancelled': 'danger',
                                        'refunded': 'secondary'
                                    } %}
                                    {% set badge_color = status_colors.get(order.status.lower(), 'dark') %}
                                    <span class="badge bg-{{ badge_color }} text-white">{{ order.status|capitalize }}</span>
                                </td>                                <td>
                                    {% if order.status in ['Packed', 'Processing'] %}
                                    <!-- Cancel Button triggers modal -->
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal{{ order.order_id }}">
                                        Cancel
                                    </button>
                                    {% elif order.status in ['Delivered'] %}
                                  <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#refundModal{{ order.order_id }}">
                                        Request Refund
                                    </button>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <p class="text-primary mt-2" style="cursor:pointer;" data-bs-toggle="collapse" data-bs-target="#collapseOrder{{ loop.index }}">
                        Click to Expand Order Details
                    </p>
                </div>

                <div id="collapseOrder{{ loop.index }}" class="collapse" data-bs-parent="#accordionOrders">
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Item Description</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set grand_total = namespace(value=0) %}
                                {% for item in order["items"] %}
                                <tr>
                                    <td>{{ item.product_name }}</td>
                                    <td>{{ item.description or 'N/A' }}</td>
                                    <td>${{ '%.2f' % item.price }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>${{ '%.2f' % (item.price * item.quantity) }}</td>
                                </tr>
                                {% set grand_total.value = grand_total.value + (item.price * item.quantity) %}
                                {% endfor %}
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total</strong></td>
                                    <td><strong>${{ '%.2f' % grand_total.value }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal for cancelling this order -->
            <div class="modal fade" id="cancelModal{{ order.order_id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ order.order_id }}" aria-hidden="true">
              <div class="modal-dialog">
                <form method="POST" action="{{ url_for('Customer.customer_cancel_order', order_id=order.order_id) }}">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="cancelModalLabel{{ order.order_id }}">Cancel Order {{ order.order_id }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <label for="cancelReason{{ order.order_id }}" class="form-label">Reason for cancellation</label>
                      <textarea class="form-control" id="cancelReason{{ order.order_id }}" name="cancel_reason" required></textarea>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-danger">Confirm Cancel</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- Refund Modal -->
            <div class="modal fade" id="refundModal{{ order.order_id }}" tabindex="-1" aria-labelledby="refundModalLabel{{ order.order_id }}" aria-hidden="true">
              <div class="modal-dialog">
                <form method="POST" action="{{ url_for('Customer.customer_request_refund', order_id=order.order_id) }}">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="refundModalLabel{{ order.order_id }}">Request Refund for Order {{ order.order_id }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <label for="refundReason{{ order.order_id }}" class="form-label">Reason for refund</label>
                      <textarea class="form-control" id="refundReason{{ order.order_id }}" name="refund_reason" required></textarea>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="submit" class="btn btn-danger">Submit Refund Request</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

        {% else %}
            <p class="mt-4 text-center">No orders found for this status.</p>
        {% endfor %}
            <div class="mt-5">
                {{ pagination.links }}
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block custom %}
<!-- Bootstrap JS Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    $("#OrderSearch").on("input", function () {
      var searchVal = $(this).val().toLowerCase();

      $(".test").each(function () {
        var text = $(this).text().toLowerCase();
        $(this).toggle(text.indexOf(searchVal) !== -1);
      });
    });
  });
</script>
{% endblock %}
